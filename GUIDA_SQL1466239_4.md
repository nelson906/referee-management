# 🔧 Guida Correzione Nomi Database Sql1466239_4

## 📋 Obiettivo
Trasformare i nomi nelle colonne **Comitato**, **TD**, **Arbitri**, **Osservatori** delle tabelle `gare_2015` fino a `gare_2025` dal formato "Cognome-Nome" al formato "Nome, Cognome" e verificare la corrispondenza con gli utenti reali nella tabella `users` del database `referee-management`.

---

## 🚨 **ATTENZIONE - BACKUP OBBLIGATORIO**
**CREARE SEMPRE UN BACKUP COMPLETO PRIMA DI QUALSIASI MODIFICA!**

---

## 📁 File Creati

1. **`fix_gare_names_sql1466239_4.sql`** - Script SQL completo
2. **`fix_gare_names.sh`** - Script bash interattivo
3. **`GUIDA_SQL1466239_4.md`** - Questa guida

---

## 🎯 Problema da Risolvere

### Situazione Attuale:
- Database: `Sql1466239_4`
- Tabelle: `gare_2015`, `gare_2016`, ..., `gare_2025`
- Colonne con nomi da correggere:
  - `Comitato`
  - `TD` (Direttore di Torneo)
  - `Arbitri`
  - `Osservatori`

### Formato Attuale → Formato Desiderato:
```
"Rossi-Mario" → "Mario, Rossi"
"Bianchi-Luigi" → "Luigi, Bianchi"
"Mario, Rossi" → "Mario, Rossi" (già corretto)
```

### Verifica:
Controllare se i nomi corretti corrispondono a utenti reali nella tabella `users` del database `referee-management`.

---

## 🚀 Come Utilizzare

### Metodo 1: Script Bash Interattivo (CONSIGLIATO)

```bash
# Esegui lo script interattivo
./fix_gare_names.sh
```

**Menu opzioni:**
1. **Analizza i dati** - Vede quanti nomi devono essere corretti
2. **Crea funzioni MySQL** - Crea la funzione di trasformazione
3. **Crea backup delle tabelle** - Backup di sicurezza
4. **Mostra anteprima modifiche** - Vede cosa cambierà
5. **Applica correzioni** - Esegue le modifiche
6. **Verifica risultati** - Controlla i risultati
7. **Processo completo** - Fa tutto in sequenza

### Metodo 2: Script SQL Manuale

```sql
-- 1. Connettiti al database
USE Sql1466239_4;

-- 2. Esegui lo script completo
SOURCE fix_gare_names_sql1466239_4.sql;
```

---

## 📊 Analisi Preliminare

### Controlla le Tabelle Esistenti:
```sql
USE Sql1466239_4;

SELECT 
    table_name,
    table_rows,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb
FROM information_schema.tables 
WHERE table_schema = 'Sql1466239_4' 
AND table_name LIKE 'gare_%'
ORDER BY table_name;
```

### Analizza i Nomi da Correggere:
```sql
-- Esempio per gare_2025
SELECT 
    'Comitato' as colonna,
    COUNT(*) as totale,
    SUM(CASE WHEN Comitato LIKE '%-%' AND Comitato NOT LIKE '%, %' THEN 1 ELSE 0 END) as da_correggere
FROM gare_2025 
WHERE Comitato IS NOT NULL AND Comitato != ''

UNION ALL

SELECT 'TD', COUNT(*), SUM(CASE WHEN TD LIKE '%-%' AND TD NOT LIKE '%, %' THEN 1 ELSE 0 END)
FROM gare_2025 WHERE TD IS NOT NULL AND TD != ''

UNION ALL

SELECT 'Arbitri', COUNT(*), SUM(CASE WHEN Arbitri LIKE '%-%' AND Arbitri NOT LIKE '%, %' THEN 1 ELSE 0 END)
FROM gare_2025 WHERE Arbitri IS NOT NULL AND Arbitri != ''

UNION ALL

SELECT 'Osservatori', COUNT(*), SUM(CASE WHEN Osservatori LIKE '%-%' AND Osservatori NOT LIKE '%, %' THEN 1 ELSE 0 END)
FROM gare_2025 WHERE Osservatori IS NOT NULL AND Osservatori != '';
```

---

## 🔧 Funzione di Trasformazione

Lo script crea automaticamente questa funzione MySQL:

```sql
DELIMITER //

CREATE FUNCTION transform_name(input_name VARCHAR(500))
RETURNS VARCHAR(500)
DETERMINISTIC
BEGIN
    -- Se contiene trattino ma non virgola, trasforma da "Cognome-Nome" a "Nome, Cognome"
    IF input_name LIKE '%-%' AND input_name NOT LIKE '%, %' THEN
        RETURN CONCAT(
            TRIM(SUBSTRING_INDEX(input_name, '-', -1)), 
            ', ', 
            TRIM(SUBSTRING_INDEX(input_name, '-', 1))
        );
    ELSE
        RETURN input_name;
    END IF;
END//

DELIMITER ;
```

### Test della Funzione:
```sql
SELECT 
    'Rossi-Mario' AS input,
    transform_name('Rossi-Mario') AS output
UNION ALL
SELECT 
    'Mario, Rossi' AS input,
    transform_name('Mario, Rossi') AS output;
```

---

## 🛡️ Backup di Sicurezza

### Backup Automatico per Ogni Tabella:
```sql
-- Esempio per gare_2025
CREATE TABLE gare_2025_backup_20250807 AS 
SELECT id, Comitato, TD, Arbitri, Osservatori, created_at, updated_at 
FROM gare_2025;
```

### Verifica Backup:
```sql
SELECT COUNT(*) FROM gare_2025_backup_20250807;
```

---

## ✅ Esecuzione delle Correzioni

### Correzione Singola Tabella (Esempio gare_2025):
```sql
-- Comitato
UPDATE gare_2025 
SET Comitato = transform_name(Comitato),
    updated_at = CURRENT_TIMESTAMP
WHERE Comitato LIKE '%-%' AND Comitato NOT LIKE '%, %';

-- TD
UPDATE gare_2025 
SET TD = transform_name(TD),
    updated_at = CURRENT_TIMESTAMP
WHERE TD LIKE '%-%' AND TD NOT LIKE '%, %';

-- Arbitri
UPDATE gare_2025 
SET Arbitri = transform_name(Arbitri),
    updated_at = CURRENT_TIMESTAMP
WHERE Arbitri LIKE '%-%' AND Arbitri NOT LIKE '%, %';

-- Osservatori
UPDATE gare_2025 
SET Osservatori = transform_name(Osservatori),
    updated_at = CURRENT_TIMESTAMP
WHERE Osservatori LIKE '%-%' AND Osservatori NOT LIKE '%, %';
```

### Correzione Tutte le Tabelle:
```sql
CALL fix_all_gare_names();
```

---

## 🔍 Verifica Corrispondenza Utenti

### Funzione di Verifica:
```sql
-- Controlla se un nome esiste nella tabella users
SELECT COUNT(*) 
FROM `referee-management`.users
WHERE UPPER(TRIM(name)) = UPPER(TRIM('Mario, Rossi'))
   OR UPPER(TRIM(name)) = UPPER(TRIM(REPLACE('Mario, Rossi', ', ', ' ')));
```

### Analisi Completa con Verifica:
```sql
SELECT 
    id,
    'Comitato' as campo,
    Comitato as originale,
    transform_name(Comitato) as trasformato,
    -- Verifica esistenza utente
    (SELECT COUNT(*) FROM `referee-management`.users 
     WHERE UPPER(TRIM(name)) = UPPER(TRIM(transform_name(Comitato)))) as utente_esiste
FROM gare_2025 
WHERE Comitato LIKE '%-%' AND Comitato NOT LIKE '%, %'
LIMIT 10;
```

---

## 📈 Verifica Risultati Finali

### Conta Nomi Ancora da Correggere:
```sql
SELECT 
    'gare_2025' as tabella,
    SUM(CASE WHEN 
        (Comitato LIKE '%-%' AND Comitato NOT LIKE '%, %') OR
        (TD LIKE '%-%' AND TD NOT LIKE '%, %') OR
        (Arbitri LIKE '%-%' AND Arbitri NOT LIKE '%, %') OR
        (Osservatori LIKE '%-%' AND Osservatori NOT LIKE '%, %')
        THEN 1 ELSE 0 END) as ancora_da_correggere
FROM gare_2025;
```

### Esempi di Nomi Corretti:
```sql
SELECT 
    id, Comitato, TD, Arbitri, Osservatori
FROM gare_2025
WHERE (Comitato LIKE '%, %' OR TD LIKE '%, %' OR Arbitri LIKE '%, %' OR Osservatori LIKE '%, %')
LIMIT 10;
```

---

## 🚨 Gestione Problemi

### Problema: Export Database Non Funziona
**Soluzioni:**
1. Usare mysqldump da command line:
   ```bash
   mysqldump -u root -p Sql1466239_4 > backup_completo.sql
   ```

2. Export singole tabelle:
   ```bash
   mysqldump -u root -p Sql1466239_4 gare_2025 > gare_2025_backup.sql
   ```

### Problema: Nomi con Formati Inaspettati
**Verifica formati anomali:**
```sql
SELECT DISTINCT 
    Comitato,
    CASE 
        WHEN Comitato LIKE '% - %' THEN 'SPAZIO_TRATTINO_SPAZIO'
        WHEN Comitato LIKE '%  %' THEN 'DOPPIO_SPAZIO'
        WHEN Comitato NOT LIKE '% %' AND Comitato LIKE '%-%' THEN 'SOLO_TRATTINO'
        ELSE 'ALTRO_FORMATO'
    END as formato
FROM gare_2025 
WHERE Comitato IS NOT NULL
ORDER BY formato;
```

### Problema: Funzione MySQL Non Si Crea
**Verifica privilegi:**
```sql
SHOW GRANTS FOR CURRENT_USER();
-- Deve avere CREATE ROUTINE
```

---

## 📋 Checklist Processo Completo

- [ ] ✅ Database Sql1466239_4 accessibile
- [ ] ✅ Backup completo database creato
- [ ] ✅ Script SQL scaricato ed eseguito
- [ ] ✅ Funzione transform_name creata e testata
- [ ] ✅ Analisi preliminare eseguita
- [ ] ✅ Backup specifico tabelle gare creato
- [ ] ✅ Anteprima modifiche verificata
- [ ] ✅ Correzioni applicate a tutte le tabelle
- [ ] ✅ Verifica risultati finali completata
- [ ] ✅ Test corrispondenza utenti eseguito
- [ ] ✅ Integrità database verificata

---

## 💡 Comandi Quick Start

```bash
# 1. Quick Analysis
./fix_gare_names.sh
# Scegli opzione 1

# 2. Processo Completo Automatico
./fix_gare_names.sh  
# Scegli opzione 7

# 3. Solo SQL
mysql -u root -p Sql1466239_4 < fix_gare_names_sql1466239_4.sql
```

---

## 📞 Note Finali

- **Tempo stimato**: 5-15 minuti per database di medie dimensioni
- **Spazio richiesto**: ~20% dello spazio database per i backup
- **Reversibilità**: Completa grazie ai backup automatici
- **Sicurezza**: Tutte le operazioni includono controlli di integrità

**Ricorda**: Sempre testare prima su una copia del database se possibile!
